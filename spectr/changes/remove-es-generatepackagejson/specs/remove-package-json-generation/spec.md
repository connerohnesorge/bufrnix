# Specification: Remove Package.json Generation Capability

**Capability ID**: `remove-package-json-generation`

**Related Change**: `remove-es-generatepackagejson`

**Status**: Draft

---

## REMOVED Requirements

### Requirement: ES Modules Auto-Generated package.json

The system SHALL NOT generate `package.json` files for Protobuf-ES generated code. The `js.es.generatePackageJson` configuration option SHALL be removed from the schema and MUST NOT be accepted in configurations.

#### Scenario: ES Modules without generatePackageJson
```nix
# New approach - generatePackageJson option is no longer available
languages.js.es = {
  enable = true;
  target = "ts";
  importExtension = ".js";
};

# Configuration that previously existed but is now invalid:
# generatePackageJson = true;     # ← This option no longer exists
# packageName = "@example/proto"; # ← This option no longer exists
```

---

### Requirement: ts-proto Auto-Generated package.json

The system SHALL NOT generate `package.json` files for ts-proto generated code. The `js.tsProto.generatePackageJson` configuration option SHALL be removed from the schema.

#### Scenario: ts-proto without generatePackageJson
```nix
# New approach
languages.js.tsProto = {
  enable = true;
  options = ["esModuleInterop=true"];
};

# Previously working but now invalid:
# generatePackageJson = true;    # ← This option no longer exists
```

---

### Requirement: Connect Auto-Generated package.json

The system SHALL NOT generate `package.json` files for Connect protocol code. The `js.connect.generatePackageJson` configuration option SHALL be removed.

#### Scenario: Connect without generatePackageJson
```nix
# New approach
languages.js.connect = {
  enable = true;
};

# Previously working but now invalid:
# generatePackageJson = true;     # ← This option no longer exists
```

---

### Requirement: Configurable Package Name in Generated package.json

The system SHALL NOT accept `packageName` configuration options for any JavaScript sub-modules. All `packageName` options MUST be removed from the configuration schema including `js.es.packageName`, `js.tsProto.packageName`, and `js.connect.packageName`.

#### Scenario: packageName option removed
```nix
# Previously working:
languages.js.es = {
  enable = true;
  packageName = "@example/proto"; # ← This option no longer exists
};

# Now results in configuration error
```

---

## ADDED Requirements

### Requirement: User-Managed JavaScript Package.json

Users MUST create and maintain their own `package.json` files for JavaScript/TypeScript projects. Bufrnix SHALL generate only protobuf code files (`.js`, `.d.ts`, `.pb.js`) and MUST NOT generate `package.json` files in any output directory.

#### Scenario: User creates package.json for ES Modules
```nix
# Configuration (user-managed package.json)
languages.js.es = {
  enable = true;
  target = "ts";
  importExtension = ".js";
};

# User creates package.json separately
# examples/js-es-modules/package.json:
# {
#   "name": "@myorg/proto",
#   "version": "1.0.0",
#   "type": "module",
#   "dependencies": {
#     "@bufbuild/protobuf": "^1.10.0"
#   }
# }
```

#### Scenario: User manages dependencies for ts-proto
```nix
# Configuration
languages.js.tsProto = {
  enable = true;
  options = ["esModuleInterop=true"];
};

# User maintains package.json with ts-proto dependencies
# {
#   "dependencies": {
#     "@grpc/grpc-js": "^1.10.0",
#     "nice-grpc": "^2.1.7"
#   }
# }
```

---

### Requirement: Configuration Schema Simplification

The configuration schema for JavaScript language modules MUST remove all package management options. Only protobuf generation options SHALL remain in the schema.

#### Scenario: Simplified ES modules configuration
```nix
# After change - clean protobuf-focused configuration
languages.js.es = {
  enable = true;           # Protobuf generation
  target = "ts";           # Protobuf generation
  importExtension = ".js"; # Protobuf generation
  options = [];            # Protobuf generation
};

# Removed package management options:
# - generatePackageJson
# - packageName
```

#### Scenario: Configuration errors for removed options
```nix
# This configuration MUST raise an error:
languages.js.es = {
  enable = true;
  generatePackageJson = true;  # ← Configuration error
};

# Error message MUST clearly indicate the option is no longer supported
```

---

### Requirement: No Generated package.json Files

Bufrnix output directories MUST NEVER contain `package.json` files generated by Bufrnix. All package management is the responsibility of the user's project.

#### Scenario: Output inspection after ES modules generation
```bash
# After running: nix build
# Generated output SHALL contain only protobuf code files
ls result/gen/js/
# Expected output:
# example_pb.js           # ← Protobuf generated
# example_pb.d.ts        # ← Protobuf generated
# google_protobuf_pb.js  # ← Protobuf generated
# (no package.json)
```

#### Scenario: ts-proto generation output
```bash
# After ts-proto generation
ls result/gen/ts-proto/
# Expected output:
# example.ts           # ← ts-proto generated
# example.pb.ts        # ← ts-proto generated
# (no package.json)
```

---

### Requirement: Documentation of Migration Path

Documentation MUST guide users through the breaking change from auto-generated to user-managed `package.json`. Migration guide MUST include before/after examples and concrete steps for each use case.

#### Scenario: User migrating ES modules configuration
```markdown
# Migration Example

## Before (Old - No Longer Works)
```nix
languages.js.es = {
  enable = true;
  generatePackageJson = true;
  packageName = "@example/proto";
};
```

## After (New - Required)
```nix
languages.js.es = {
  enable = true;
};

# Create package.json in project:
# {
#   "name": "@example/proto",
#   "dependencies": {
#     "@bufbuild/protobuf": "^1.10.0"
#   }
# }
```
```

#### Scenario: Finding migration guidance
Migration guide must exist at `doc/src/content/docs/guides/migrating-from-generatepackagejson.mdx` with:
- Clear explanation of the change
- Before/after configuration examples
- Example `package.json` templates for ES modules and ts-proto
- Migration checklist
- Links from main documentation
